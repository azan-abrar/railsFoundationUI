
var app = angular.module("confizHRM", ['ngSanitize', 'ngCookies', 'ui.utils']);

app.config(function($routeProvider) {

  // HomeController Routes

  $routeProvider.when('/', {
    templateUrl: '<%= asset_path("index.html") %>',
    controller: 'HomeController'
  });

  $routeProvider.when('/home', {
    templateUrl: '<%= asset_path("home.html") %>',
    controller: 'HomeController'
  });

  // LoginController Routes

  $routeProvider.when('/login', {
    templateUrl: '<%= asset_path("login.html") %>',
    controller: 'LoginController'
  });

  $routeProvider.when('/confirmation', {
    templateUrl: '<%= asset_path("confirmation.html") %>',
    controller: 'LoginController'
  });

  // EmployeesController Routes

  $routeProvider.when('/employees', {
    templateUrl: '<%= asset_path("employees.html") %>',
    controller: 'EmployeesController',
  });

  $routeProvider.when('/employee/new', {
   templateUrl: '<%= asset_path("employees/edit.html") %>',
 });

  $routeProvider.when('/employee/:employeeID', {
    templateUrl: '<%= asset_path("employees/show.html") %>',
    controller: 'EmployeesController'
  });

  $routeProvider.when('/employee/:employeeID/edit', {
    templateUrl: '<%= asset_path("employees/edit.html") %>',
    controller: 'EmployeesController'
  });
  
  // DepartmentsController Routes

  $routeProvider.when('/departments', {
    templateUrl: '<%= asset_path("departments.html") %>',
    controller: 'DepartmentsController',
    
  });

  $routeProvider.when('/department/new', {
    templateUrl: '<%= asset_path("departments/edit.html") %>',
  });

  $routeProvider.when('/department/:departmentID', {
    templateUrl: '<%= asset_path("departments/show.html") %>',
    controller: 'DepartmentsController'
  });

  $routeProvider.when('/department/:departmentID/edit', {
    templateUrl: '<%= asset_path("departments/edit.html") %>',
    controller: 'DepartmentsController'
  });

  // Redirect to index page of employees in case of route does no match

  $routeProvider.otherwise({redirectTo: '/'});

});

app.run(function($rootScope, $location, AuthenticationService, FlashService, Navigation) {
  var routesIfNotLogin = ['/employees', '/departments', '/home'];

  $rootScope.$on('$routeChangeStart', function(event, next, current) {

    if (_(['/login']).contains($location.path())) {
      FlashService.clear();
      Navigation.hideNav();
    } else {
      Navigation.showNav();
      
      AuthenticationService.isLoggedIn().success(function() {
        if (_(routesIfNotLogin).contains($location.path()) || $location.$$absUrl.match("/companies") != null) {
          setTimeout(function() {
            $('li.has-dropdown ul li').on('mouseover', function() {
             $(this).parent().parent().find('a.parent').addClass('active');
           });

            $('li.has-dropdown ul li').on('mouseout', function() {
              $(this).parent().parent().find('a.parent').removeClass('active');
            });
          }, 1000);
        } else if (_(['/']).contains($location.path())) {
          FlashService.clear();
          $location.path('/home');
        } 
      }).error(function() {
        if (_(routesIfNotLogin).contains($location.path())) {
          FlashService.clear();
          Navigation.hideNav();
          $location.path('/login');
        }
      });
    }
  });
});